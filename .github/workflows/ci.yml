# CI/CD Pipeline - Optimized for Speed
# Target: <7 minutes total runtime
# Optimizations: Parallel execution, caching, incremental builds

name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# SECURITY: Restrict permissions to minimum required
permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '10'

jobs:
  # ============================================
  # Stage 1: Setup & Change Detection
  # ============================================
  changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      root: ${{ steps.filter.outputs.root }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            backend:
              - 'backend/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            root:
              - 'package.json'
              - 'pnpm-lock.yaml'
              - '.github/workflows/**'

  # ============================================
  # Stage 2: Install Dependencies (Parallel)
  # ============================================
  install:
    name: üì¶ Install Dependencies
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache node_modules
        uses: actions/cache@v4
        id: node-modules-cache
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile

  # ============================================
  # Stage 3: Code Quality (Parallel)
  # ============================================
  lint-frontend:
    name: üîç Lint Frontend
    runs-on: ubuntu-latest
    needs: [install, changes]
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.root == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (fallback)
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm --filter frontend lint
        continue-on-error: false

  lint-backend:
    name: üîç Lint Backend
    runs-on: ubuntu-latest
    needs: [install, changes]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.root == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (fallback)
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm --filter @the-copy/backend lint
        continue-on-error: false

  typecheck-frontend:
    name: üìù TypeCheck Frontend
    runs-on: ubuntu-latest
    needs: [install, changes]
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.root == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (fallback)
        run: pnpm install --frozen-lockfile

      - name: Run TypeCheck
        run: pnpm --filter frontend typecheck

  typecheck-backend:
    name: üìù TypeCheck Backend
    runs-on: ubuntu-latest
    needs: [install, changes]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.root == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (fallback)
        run: pnpm install --frozen-lockfile

      - name: Run TypeCheck
        run: pnpm --filter @the-copy/backend typecheck

  # ============================================
  # Stage 4: Tests (Parallel)
  # ============================================
  test-frontend:
    name: üß™ Test Frontend
    runs-on: ubuntu-latest
    needs: [install, changes]
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.root == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (fallback)
        run: pnpm install --frozen-lockfile

      - name: Run Tests
        run: pnpm --filter frontend test

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          fail_ci_if_error: false

  test-backend:
    name: üß™ Test Backend
    runs-on: ubuntu-latest
    needs: [install, changes]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.root == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (fallback)
        run: pnpm install --frozen-lockfile

      - name: Run Tests
        run: pnpm --filter @the-copy/backend test

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          fail_ci_if_error: false

  # ============================================
  # Stage 5: Build (Parallel with caching)
  # ============================================
  build-frontend:
    name: üèóÔ∏è Build Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [lint-frontend, typecheck-frontend, test-frontend, changes]
    if: |
      always() &&
      (needs.changes.outputs.frontend == 'true' || needs.changes.outputs.root == 'true') &&
      (needs.lint-frontend.result == 'success' || needs.lint-frontend.result == 'skipped') &&
      (needs.typecheck-frontend.result == 'success' || needs.typecheck-frontend.result == 'skipped') &&
      (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped')
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (fallback)
        run: pnpm install --frozen-lockfile

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            frontend/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('frontend/**/*.ts', 'frontend/**/*.tsx', 'frontend/**/*.css') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-

      - name: Build Frontend
        run: pnpm --filter frontend build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/.next
          retention-days: 1

  build-backend:
    name: üèóÔ∏è Build Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [lint-backend, typecheck-backend, test-backend, changes]
    if: |
      always() &&
      (needs.changes.outputs.backend == 'true' || needs.changes.outputs.root == 'true') &&
      (needs.lint-backend.result == 'success' || needs.lint-backend.result == 'skipped') &&
      (needs.typecheck-backend.result == 'success' || needs.typecheck-backend.result == 'skipped') &&
      (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped')
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (fallback)
        run: pnpm install --frozen-lockfile

      - name: Cache TypeScript build
        uses: actions/cache@v4
        with:
          path: |
            backend/dist
            backend/tsconfig.tsbuildinfo
          key: ${{ runner.os }}-backend-build-${{ hashFiles('backend/src/**/*.ts') }}
          restore-keys: |
            ${{ runner.os }}-backend-build-

      - name: Build Backend
        run: pnpm --filter @the-copy/backend build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend/dist
          retention-days: 1

  # ============================================
  # Stage 6: E2E Tests (Optional, on PR)
  # ============================================
  e2e-tests:
    name: üé≠ E2E Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [build-frontend, changes]
    if: |
      github.event_name == 'pull_request' &&
      needs.changes.outputs.frontend == 'true' &&
      needs.build-frontend.result == 'success'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            backend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (fallback)
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm --filter frontend exec playwright install --with-deps chromium

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/.next

      - name: Run E2E tests
        run: pnpm --filter frontend e2e
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report
          retention-days: 7

  # ============================================
  # Final Stage: Status Check
  # ============================================
  ci-status:
    name: ‚úÖ CI Status
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [build-frontend, build-backend, e2e-tests]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Check CI status
        run: |
          echo "Frontend Build: ${{ needs.build-frontend.result }}"
          echo "Backend Build: ${{ needs.build-backend.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"

          if [[ "${{ needs.build-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.build-backend.result }}" == "failure" ]]; then
            echo "‚ùå CI failed"
            exit 1
          fi

          echo "‚úÖ CI passed"