name: Coverage Verification

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

# SECURITY: Restrict permissions to minimum required at workflow level
permissions:
  contents: read
  actions: read

jobs:
  coverage-frontend:
    name: üìä Frontend Coverage Check
    runs-on: ubuntu-latest
    # Only run on the original repository
    if: github.repository == 'CLOCKWORK-TEMPTATION/the...copy'
    permissions:
      checks: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm --filter frontend test:coverage
        continue-on-error: false

      - name: Check coverage thresholds
        run: |
          echo "Verifying Frontend Coverage Thresholds..."
          if [ ! -f ./frontend/coverage/coverage-summary.json ]; then
            echo "‚ùå Coverage summary not found"
            exit 1
          fi
          
          LINES=$(grep -o '"lines":[^}]*' ./frontend/coverage/coverage-summary.json | grep -o '[0-9.]*' | head -1)
          FUNCTIONS=$(grep -o '"functions":[^}]*' ./frontend/coverage/coverage-summary.json | grep -o '[0-9.]*' | head -1)
          BRANCHES=$(grep -o '"branches":[^}]*' ./frontend/coverage/coverage-summary.json | grep -o '[0-9.]*' | head -1)
          STATEMENTS=$(grep -o '"statements":[^}]*' ./frontend/coverage/coverage-summary.json | grep -o '[0-9.]*' | head -1)
          
          echo "Frontend Coverage Results:"
          echo "  Lines: ${LINES}% (threshold: 85%)"
          echo "  Functions: ${FUNCTIONS}% (threshold: 85%)"
          echo "  Branches: ${BRANCHES}% (threshold: 80%)"
          echo "  Statements: ${STATEMENTS}% (threshold: 85%)"
          
          THRESHOLD_LINES=85
          THRESHOLD_FUNCTIONS=85
          THRESHOLD_BRANCHES=80
          THRESHOLD_STATEMENTS=85
          
          FAILED=false
          if (( $(echo "$LINES < $THRESHOLD_LINES" | bc -l) )); then
            echo "‚ùå Lines coverage ($LINES%) below threshold ($THRESHOLD_LINES%)"
            FAILED=true
          fi
          
          if (( $(echo "$FUNCTIONS < $THRESHOLD_FUNCTIONS" | bc -l) )); then
            echo "‚ùå Functions coverage ($FUNCTIONS%) below threshold ($THRESHOLD_FUNCTIONS%)"
            FAILED=true
          fi
          
          if (( $(echo "$BRANCHES < $THRESHOLD_BRANCHES" | bc -l) )); then
            echo "‚ùå Branches coverage ($BRANCHES%) below threshold ($THRESHOLD_BRANCHES%)"
            FAILED=true
          fi
          
          if (( $(echo "$STATEMENTS < $THRESHOLD_STATEMENTS" | bc -l) )); then
            echo "‚ùå Statements coverage ($STATEMENTS%) below threshold ($THRESHOLD_STATEMENTS%)"
            FAILED=true
          fi
          
          if [ "$FAILED" = true ]; then
            exit 1
          else
            echo "‚úÖ All coverage thresholds met!"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: Comment PR with coverage results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('./frontend/coverage/coverage-summary.json', 'utf8'));
            const total = summary.total;
            
            const comment = `## üìä Frontend Coverage Report
            
            | Metric | Coverage | Threshold | Status |
            |--------|----------|-----------|--------|
            | Lines | ${total.lines.pct.toFixed(2)}% | 85% | ${total.lines.pct >= 85 ? '‚úÖ' : '‚ùå'} |
            | Functions | ${total.functions.pct.toFixed(2)}% | 85% | ${total.functions.pct >= 85 ? '‚úÖ' : '‚ùå'} |
            | Branches | ${total.branches.pct.toFixed(2)}% | 80% | ${total.branches.pct >= 80 ? '‚úÖ' : '‚ùå'} |
            | Statements | ${total.statements.pct.toFixed(2)}% | 85% | ${total.statements.pct >= 85 ? '‚úÖ' : '‚ùå'} |
            
            [View detailed coverage report](https://codecov.io/gh/${{ github.repository }}/pulls/${{ github.event.pull_request.number }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  coverage-backend:
    name: üìä Backend Coverage Check
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm --filter @the-copy/backend test:coverage
        continue-on-error: false

      - name: Check coverage thresholds
        run: |
          echo "Verifying Backend Coverage Thresholds..."
          if [ ! -f ./backend/coverage/coverage-summary.json ]; then
            echo "‚ùå Coverage summary not found"
            exit 1
          fi
          
          LINES=$(grep -o '"lines":[^}]*' ./backend/coverage/coverage-summary.json | grep -o '[0-9.]*' | head -1)
          FUNCTIONS=$(grep -o '"functions":[^}]*' ./backend/coverage/coverage-summary.json | grep -o '[0-9.]*' | head -1)
          BRANCHES=$(grep -o '"branches":[^}]*' ./backend/coverage/coverage-summary.json | grep -o '[0-9.]*' | head -1)
          STATEMENTS=$(grep -o '"statements":[^}]*' ./backend/coverage/coverage-summary.json | grep -o '[0-9.]*' | head -1)
          
          echo "Backend Coverage Results:"
          echo "  Lines: ${LINES}% (threshold: 85%)"
          echo "  Functions: ${FUNCTIONS}% (threshold: 85%)"
          echo "  Branches: ${BRANCHES}% (threshold: 80%)"
          echo "  Statements: ${STATEMENTS}% (threshold: 85%)"
          
          THRESHOLD_LINES=85
          THRESHOLD_FUNCTIONS=85
          THRESHOLD_BRANCHES=80
          THRESHOLD_STATEMENTS=85
          
          FAILED=false
          if (( $(echo "$LINES < $THRESHOLD_LINES" | bc -l) )); then
            echo "‚ùå Lines coverage ($LINES%) below threshold ($THRESHOLD_LINES%)"
            FAILED=true
          fi
          
          if (( $(echo "$FUNCTIONS < $THRESHOLD_FUNCTIONS" | bc -l) )); then
            echo "‚ùå Functions coverage ($FUNCTIONS%) below threshold ($THRESHOLD_FUNCTIONS%)"
            FAILED=true
          fi
          
          if (( $(echo "$BRANCHES < $THRESHOLD_BRANCHES" | bc -l) )); then
            echo "‚ùå Branches coverage ($BRANCHES%) below threshold ($THRESHOLD_BRANCHES%)"
            FAILED=true
          fi
          
          if (( $(echo "$STATEMENTS < $THRESHOLD_STATEMENTS" | bc -l) )); then
            echo "‚ùå Statements coverage ($STATEMENTS%) below threshold ($THRESHOLD_STATEMENTS%)"
            FAILED=true
          fi
          
          if [ "$FAILED" = true ]; then
            exit 1
          else
            echo "‚úÖ All coverage thresholds met!"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Comment PR with coverage results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('./backend/coverage/coverage-summary.json', 'utf8'));
            const total = summary.total;
            
            const comment = `## üìä Backend Coverage Report
            
            | Metric | Coverage | Threshold | Status |
            |--------|----------|-----------|--------|
            | Lines | ${total.lines.pct.toFixed(2)}% | 85% | ${total.lines.pct >= 85 ? '‚úÖ' : '‚ùå'} |
            | Functions | ${total.functions.pct.toFixed(2)}% | 85% | ${total.functions.pct >= 85 ? '‚úÖ' : '‚ùå'} |
            | Branches | ${total.branches.pct.toFixed(2)}% | 80% | ${total.branches.pct >= 80 ? '‚úÖ' : '‚ùå'} |
            | Statements | ${total.statements.pct.toFixed(2)}% | 85% | ${total.statements.pct >= 85 ? '‚úÖ' : '‚ùå'} |
            
            [View detailed coverage report](https://codecov.io/gh/${{ github.repository }}/pulls/${{ github.event.pull_request.number }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  coverage-report:
    name: üìà Generate Coverage Report
    runs-on: ubuntu-latest
    needs: [coverage-frontend, coverage-backend]
    if: always()
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Generate badge
        run: |
          mkdir -p .github/badges
          echo "Badge generation script for coverage badges"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            frontend/coverage
            backend/coverage
          retention-days: 30
