import { TaskType } from "@core/types";
import { BaseAgent } from "../shared/BaseAgent";
import {
  StandardAgentInput,
  StandardAgentOutput,
} from "../shared/standardAgentPattern";

/**
 * VisualCinematicAnalyzerAgent - محلل السياق البصري والسينمائي
 * يطبق النمط القياسي: RAG → Self-Critique → Constitutional → Uncertainty → Hallucination → Debate
 * يحلل العناصر البصرية والسينمائية وقابلية التصوير
 */
export class VisualCinematicAnalyzerAgent extends BaseAgent {
  constructor() {
    super(
      "CinemaVision AI",
      TaskType.VISUAL_CINEMATIC_ANALYZER,
      `أنت CinemaVision AI، محلل سينمائي بصري متقدم. مهمتك هي تحليل النصوص السردية (سيناريوهات، روايات) وتفكيكها إلى عناصرها البصرية والسينمائية.

يجب أن تركز على كيفية ترجمة الكلمات المكتوبة إلى صور متحركة، مع الأخذ في الاعتبار الجوانب الفنية والإنتاجية.

عند تحليل أي نص، قم بما يلي:

1. **تحديد العناصر البصرية الرئيسية**: استخرج ووصف كل العناصر القابلة للتصوير:
   - الديكور والمواقع
   - الإضاءة والألوان
   - الأزياء والإكسسوارات
   - الرموز البصرية

2. **تحليل التكوين والإخراج**: اقترح تكوينات للكاميرا:
   - زوايا الكاميرا (علوية، منخفضة، مستوى النظر)
   - حركات الكاميرا (ثابتة، بانوراما، تتبع، درون)
   - أنواع اللقطات (قريبة، متوسطة، واسعة)
   - التكوين البصري للإطار

3. **تقييم القابلية للتصوير**: حلل مدى واقعية وصعوبة التنفيذ:
   - المتطلبات التقنية
   - التحديات الإنتاجية
   - اعتبارات الميزانية
   - البدائل الإبداعية

4. **كشف الرمزية البصرية**: ابحث عن الرموز والاستعارات البصرية:
   - الألوان الرمزية
   - الأشياء ذات المعنى
   - التكرارات البصرية
   - الاستعارات المرئية

5. **تحليل الأجواء والإيقاع**: صف الأجواء (Mood) وكيفية تحقيقها:
   - الإضاءة والظلال
   - تصميم الصوت
   - الإيقاع البصري للمونتاج
   - التدفق السردي

يجب أن يكون تحليلك دقيقاً، مبدعاً، وقابلاً للتنفيذ من قبل فريق إنتاج سينمائي.

مخرجاتك يجب أن تكون نصية فقط، واضحة ومباشرة بدون أي JSON أو كتل كود.`
    );

    this.confidenceFloor = 0.75;
  }

  /**
   * بناء الـ prompt من المدخلات
   */
  protected buildPrompt(input: StandardAgentInput): string {
    const { input: userInput, context } = input;

    let prompt = `## مهمة التحليل البصري والسينمائي

${userInput}

`;

    // إضافة السياق من المحطات السابقة
    const contextObj =
      typeof context === "object" && context !== null ? context : {};
    const previousStations = (contextObj as any)?.previousStations;
    
    if (previousStations) {
      prompt += `## السياق من المحطات السابقة:\n`;

      if (previousStations.analysis) {
        prompt += `\n### التحليل الأولي:\n${previousStations.analysis}\n`;
      }

      if (previousStations.sceneDescriptions) {
        prompt += `\n### وصف المشاهد:\n${previousStations.sceneDescriptions}\n`;
      }

      if (previousStations.mood) {
        prompt += `\n### الأجواء المطلوبة:\n${previousStations.mood}\n`;
      }
    }

    prompt += `

## متطلبات التحليل البصري والسينمائي:

1. **العناصر البصرية**: حدد جميع العناصر القابلة للتصوير (ديكور، إضاءة، ألوان، أزياء)
2. **التكوين الإخراجي**: اقترح زوايا وحركات وأنواع اللقطات
3. **تقييم القابلية للتصوير**: حلل الواقعية والتحديات التقنية
4. **الرمزية البصرية**: اكشف الرموز والاستعارات المرئية
5. **الأجواء والإيقاع**: صف كيفية تحقيق المزاج المطلوب بصرياً

## التنسيق المطلوب:

اكتب تحليلك في نص واضح ومنظم:
- استخدم العناوين والفقرات لتنظيم التحليل
- قدم اقتراحات إخراجية محددة وقابلة للتنفيذ
- وضّح التحديات وكيفية التغلب عليها
- اربط العناصر البصرية بالمعنى السردي
- تجنب تماماً أي JSON أو كتل كود

قدم تحليلاً سينمائياً عملياً يساعد فريق الإنتاج على تحويل النص إلى صور متحركة فعالة.`;

    return prompt;
  }

  /**
   * معالجة ما بعد التنفيذ - تنظيف المخرجات من JSON
   */
  protected override async postProcess(
    output: StandardAgentOutput
  ): Promise<StandardAgentOutput> {
    let cleanedText = output.text;

    // إزالة أي كتل JSON
    cleanedText = cleanedText.replace(/```json\s*\n[\s\S]*?\n```/g, "");
    cleanedText = cleanedText.replace(/```\s*\n[\s\S]*?\n```/g, "");

    // إزالة أي JSON objects ظاهرة
    cleanedText = cleanedText.replace(/\{[\s\S]*?"[^"]*"\s*:[\s\S]*?\}/g, "");

    // تنظيف المسافات الزائدة
    cleanedText = cleanedText.replace(/\n{3,}/g, "\n\n").trim();

    // إضافة ملاحظة حول جودة التحليل البصري
    const enhancedNotes: string[] = [...(output.notes || [])];

    if (output.confidence >= 0.85) {
      enhancedNotes.push("تحليل سينمائي شامل مع رؤى إخراجية قوية");
    } else if (output.confidence >= 0.7) {
      enhancedNotes.push("تحليل بصري جيد مع اقتراحات عملية");
    } else {
      enhancedNotes.push("تحليل أولي يحتاج مراجعة فنية");
    }

    return {
      ...output,
      text: cleanedText,
      notes: enhancedNotes,
    };
  }

  /**
   * استجابة احتياطية في حالة الفشل
   */
  protected override async getFallbackResponse(
    input: StandardAgentInput
  ): Promise<string> {
    return `# التحليل البصري والسينمائي - وضع الطوارئ

بناءً على المعلومات المتاحة، إليك تحليل أولي للجوانب البصرية والسينمائية:

## الرؤية البصرية العامة

النص المقدم يحتوي على إمكانيات بصرية تحتاج إلى استكشاف سينمائي:

### العناصر البصرية الأساسية:
- **الديكور**: تحديد الأماكن والمواقع المطلوبة
- **الإضاءة**: اختيار الإضاءة المناسبة للمزاج
- **الألوان**: لوحة ألوان تعبر عن المشاعر
- **الأزياء**: ملابس تعكس الشخصيات والفترة

### المعالجة الإخراجية:
- **زوايا الكاميرا**: متنوعة لخلق ديناميكية بصرية
- **حركة الكاميرا**: ثابتة أو متحركة حسب الحاجة
- **أنواع اللقطات**: مزيج من القريبة والواسعة
- **التكوين**: توازن بصري في الإطار

### التحديات الإنتاجية:
- المواقع: توفر واختيار الأماكن المناسبة
- التقنيات: المعدات والتقنيات المطلوبة
- الميزانية: التكلفة المتوقعة للتنفيذ
- الوقت: الجدول الزمني للتصوير

### الرمزية البصرية:
- استخدام الألوان رمزياً
- الأشياء كرموز للمعاني
- التكرار البصري للتأكيد
- الاستعارات المرئية

## التوصيات:

- خطط بعناية للتكوين البصري لكل مشهد
- استخدم الإضاءة لخلق المزاج المطلوب
- اختر زوايا الكاميرا التي تخدم السرد
- فكر في البدائل لتوفير الميزانية

ملاحظة: هذا تحليل أولي. يُنصح بإعادة التحليل مع وصف أكثر تفصيلاً للمشاهد والرؤية الإخراجية.`;
  }
}

// Export singleton instance
export const visualCinematicAnalyzerAgent = new VisualCinematicAnalyzerAgent();
